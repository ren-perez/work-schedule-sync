# workflows/scraper-sync-workflow.yaml
main:
  steps:
    - init:
        assign:
          - project: "work-schedule-sync-472118"
          - region: "us-central1"
          - bucket: "work-schedule-sync-prod"
          - scraperJob: "scraper-job"
          - syncJob: "sync-job"

    # compute date + timestamp and build the exact GCS path we want the scraper to write
    - make_paths:
        assign:
          - full_timestamp: ${time.format(sys.now())}
          - run_date: ${text.substring(full_timestamp, 0, 10)}
          - date_path: ${text.replace_all(text.substring(full_timestamp, 0, 10), "-", "/")}
          - timestamp: ${text.replace_all(text.replace_all(text.substring(full_timestamp, 0, 19), "-", ""), ":", "") + "Z"}
          - gcs_path: ${"gs://" + bucket + "/single/" + date_path + "/schedule-" + timestamp + ".json"}

    - runScraper:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: ${"namespaces/" + project + "/jobs/" + scraperJob}
          location: ${region}
          body:
            overrides:
              containerOverrides:
                args:
                  - ${"--gcs_path=" + gcs_path}
        result: scraperResp

    - runSync:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: ${"namespaces/" + project + "/jobs/" + syncJob}
          location: ${region}
          body:
            overrides:
              containerOverrides:
                args:
                  - ${"--gcs_path=" + gcs_path}
        result: syncResp

    - returnResult:
        return:
          status: "ok"
          run_date: ${run_date}
          gcs_path: ${gcs_path}
          scraper: ${scraperResp}
          sync: ${syncResp}
